use contracts::tests::test_data::counter_evm_bytecode;
use evm::create_helpers::MachineCreateHelpers;
use evm::tests::test_utils::setup_machine;
use starknet::EthAddress;

#[test]
#[available_gas(3_000_000_000_000)]
fn test_get_create2_address() {
    let machine = setup_machine();
    let bytecode = counter_evm_bytecode();
    let salt = 0xbeef;
    let from: EthAddress = 0xF39FD6E51AAD88F6F4CE6AB8827279CFFFB92266
        .try_into()
        .expect('Wrong Eth address');

    let address = machine
        .get_create2_address(from, salt, bytecode)
        .expect('get_create2_address fail');

    // TODO
    // add SNJS script for:
    // import { getContractAddress } from 'viem'
    // const address = getContractAddress({
    //   bytecode: '0x608060405234801561001057600080fd5b506004361061004c5760003560e01c806306661abd14610051578063371303c01461006f5780636d4ce63c14610079578063b3bcfa8214610097575b600080fd5b6100596100a1565b60405161006691906100ff565b60405180910390f35b6100776100a7565b005b6100816100c2565b60405161008e91906100ff565b60405180910390f35b61009f6100cb565b005b60005481565b60016000808282546100b99190610149565b92505081905550565b60008054905090565b60016000808282546100dd919061017d565b92505081905550565b6000819050919050565b6100f9816100e6565b82525050565b600060208201905061011460008301846100f0565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610154826100e6565b915061015f836100e6565b92508282019050808211156101775761017661011a565b5b92915050565b6000610188826100e6565b9150610193836100e6565b92508282039050818111156101ab576101aa61011a565b5b9291505056fea264697066735822122018871123a335b5801c062efe14be38b2432d02e2534e1c282c6f5e7bbef8c46464736f6c63430008130033',
    //   from: '0xF39FD6E51AAD88F6F4CE6AB8827279CFFFB92266',
    //   opcode: 'CREATE2',
    //   salt: '0xbeef',
    // });

    // console.log(address)
    assert(
        address == 0x2C505580f6344e2907c90c313483aa7352e62Ad2
            .try_into()
            .expect('Wrong Eth Address'),
        'wrong create2 address'
    );
}
